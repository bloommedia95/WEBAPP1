<%- include('partials/head') %>
<%- include('partials/sidebar') %>
<%- include('partials/topbar') %>

<div class="content">
  <h1 class="page-title">Coupons</h1>

  <!-- Success/Error Messages -->
  <% if (typeof message !== 'undefined' && message) { %>
    <div class="alert alert-success alert-dismissible">
      <button type="button" class="close" onclick="this.parentElement.style.display='none'">&times;</button>
      <%= message %>
    </div>
  <% } %>

  <% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-danger alert-dismissible">
      <button type="button" class="close" onclick="this.parentElement.style.display='none'">&times;</button>
      <%= error %>
    </div>
  <% } %>

  <!-- Add Coupon Form - only show if user has create permission -->
  <% if (userRole === 'superadmin' || hasFullAccess || (userPermissions && userPermissions.coupons && userPermissions.coupons.create)) { %>
  <div class="form-wrap mb-6">
    <form action="/api/coupons" method="POST" enctype="multipart/form-data" id="couponForm">

              <!-- Hidden field for edit mode -->
              <% if (typeof editCoupon !== 'undefined' && editCoupon) { %>
                <input type="hidden" name="editId" value="<%= editCoupon._id %>">
              <% } %>

              <!-- Row 1: Title, Code, Discount Type -->
              <div class="form-row" style="display: flex; flex-wrap: wrap; margin-left: -10px; margin-right: -10px;">
                <div class="form-group col-md-4" style="flex: 0 0 33.333333%; max-width: 33.333333%; padding-left: 10px; padding-right: 10px; margin-bottom: 1rem;">
                  <label for="title" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 14px;">Coupon Title <span class="required" style="color: #dc3545;">*</span></label>
                  <input type="text" id="title" name="title" class="form-control" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                         placeholder="Coupon Title" 
                         value="<%= typeof editCoupon !== 'undefined' && editCoupon ? editCoupon.title : '' %>" 
                         required>
                  <div class="form-error" id="title-error"></div>
                </div>
                
                <div class="form-group col-md-4" style="flex: 0 0 33.333333%; max-width: 33.333333%; padding-left: 10px; padding-right: 10px; margin-bottom: 1rem;">
                  <label for="code" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 14px;">Coupon Code <span class="required" style="color: #dc3545;">*</span></label>
                  <input type="text" id="code" name="code" class="form-control" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                         placeholder="e.g., SAVE20" 
                         value="<%= typeof editCoupon !== 'undefined' && editCoupon ? editCoupon.code : '' %>" 
                         required style="text-transform: uppercase;">
                  <div class="form-error" id="code-error"></div>
                </div>

                <div class="form-group col-md-4" style="flex: 0 0 33.333333%; max-width: 33.333333%; padding-left: 10px; padding-right: 10px; margin-bottom: 1rem;">
                  <label for="discountType" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 14px;">Discount Type <span class="required" style="color: #dc3545;">*</span></label>
                  <select id="discountType" name="discountType" class="form-control" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" required onchange="toggleMaxDiscount()">
                    <option value="">Select Type</option>
                    <option value="flat" <%= typeof editCoupon !== 'undefined' && editCoupon && editCoupon.discountType === 'flat' ? 'selected' : '' %>>Flat Amount</option>
                    <option value="percentage" <%= typeof editCoupon !== 'undefined' && editCoupon && editCoupon.discountType === 'percentage' ? 'selected' : '' %>>Percentage</option>
                  </select>
                  <div class="form-error" id="discountType-error"></div>
                </div>
              </div>

              <!-- Row 2: Discount Value, Min Purchase, Max Discount -->
              <div class="form-row" style="display: flex; flex-wrap: wrap; margin-left: -10px; margin-right: -10px;">
                <div class="form-group col-md-4" style="flex: 0 0 33.333333%; max-width: 33.333333%; padding-left: 10px; padding-right: 10px; margin-bottom: 1rem;">
                  <label for="discount" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 14px;">Discount Value <span class="required" style="color: #dc3545;">*</span></label>
                  <div class="input-group" style="display: flex; align-items: stretch;">
                    <input type="number" id="discount" name="discount" class="form-control" style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px 0 0 4px; font-size: 14px; border-right: 0;"
                           placeholder="Value" 
                           value="<%= typeof editCoupon !== 'undefined' && editCoupon ? editCoupon.discount || '' : '' %>" 
                           required min="0" step="0.01">
                    <div class="input-group-append" style="display: flex;">
                      <span class="input-group-text" id="discount-symbol" style="padding: 8px 12px; background: #e9ecef; border: 1px solid #ddd; border-radius: 0 4px 4px 0; display: flex; align-items: center; line-height: 1;">‚Çπ</span>
                    </div>
                  </div>
                  <div class="form-error" id="discount-error"></div>
                </div>

                <div class="form-group col-md-4" style="flex: 0 0 33.333333%; max-width: 33.333333%; padding-left: 10px; padding-right: 10px; margin-bottom: 1rem;">
                  <label for="minPurchase" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 14px;">Min Purchase</label>
                  <input type="number" id="minPurchase" name="minPurchase" class="form-control" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                         placeholder="Min Amount" 
                         value="<%= typeof editCoupon !== 'undefined' && editCoupon ? editCoupon.minPurchase || '' : '' %>" 
                         min="0" step="0.01">
                  <div class="form-error" id="minPurchase-error"></div>
                </div>

                <div class="form-group col-md-4" style="flex: 0 0 33.333333%; max-width: 33.333333%; padding-left: 10px; padding-right: 10px; margin-bottom: 1rem;">
                  <label for="img" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 14px;">Coupon Image</label>
                  <% if (typeof editCoupon !== 'undefined' && editCoupon && editCoupon.img) { %>
                    <div class="current-image mb-2">
                      <img src="<%= editCoupon.img %>" alt="<%= editCoupon.title %>" width="50" class="img-thumbnail">
                    </div>
                  <% } %>
                  <input type="file" id="img" name="img" class="form-control-file" accept="image/*" onchange="previewImage(this)" style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                  <div id="imagePreview" style="display: none; margin-top: 10px;">
                    <img id="preview" src="#" alt="Preview" width="50" class="img-thumbnail">
                  </div>
                  <div class="form-error" id="img-error"></div>
                </div>
              </div>

              <!-- Row 4: Start Date, End Date -->

              <!-- Row 3: First Order Only, Status, Max Discount -->
              <div class="form-row" style="display: flex; flex-wrap: wrap; margin-left: -10px; margin-right: -10px;">
                <div class="form-group col-md-4" style="flex: 0 0 33.333333%; max-width: 33.333333%; padding-left: 10px; padding-right: 10px; margin-bottom: 1rem;">
                  <label for="firstOrderOnly" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 14px;">First Order Only</label>
                  <div class="form-check-inline mt-2">
                    <label class="form-check-label mr-4">
                      <input type="radio" id="firstOrderYes" name="firstOrderOnly" value="true" class="form-check-input"
                             <%= typeof editCoupon !== 'undefined' && editCoupon && editCoupon.firstOrderOnly ? 'checked' : '' %>>
                      Yes
                    </label>
                    <label class="form-check-label">
                      <input type="radio" id="firstOrderNo" name="firstOrderOnly" value="false" class="form-check-input"
                             <%= typeof editCoupon !== 'undefined' && editCoupon && !editCoupon.firstOrderOnly ? 'checked' : (!editCoupon ? 'checked' : '') %>>
                      No
                    </label>
                  </div>
                  <div class="form-error" id="firstOrderOnly-error"></div>
                </div>

                <div class="form-group col-md-4" style="flex: 0 0 33.333333%; max-width: 33.333333%; padding-left: 10px; padding-right: 10px; margin-bottom: 1rem;">
                  <label for="status" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 14px;">Status</label>
                  <select id="status" name="status" class="form-control" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <option value="Active" <%= typeof editCoupon !== 'undefined' && editCoupon && editCoupon.status === 'Active' ? 'selected' : '' %>>Active</option>
                    <option value="Inactive" <%= typeof editCoupon !== 'undefined' && editCoupon && editCoupon.status === 'Inactive' ? 'selected' : (!editCoupon ? 'selected' : '') %>>Inactive</option>
                  </select>
                  <div class="form-error" id="status-error"></div>
                </div>

                <div class="form-group col-md-4" id="maxDiscountGroup" style="flex: 0 0 33.333333%; max-width: 33.333333%; padding-left: 10px; padding-right: 10px; margin-bottom: 1rem;">
                  <label for="maxDiscount" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 14px;">Max Discount</label>
                  <input type="number" id="maxDiscount" name="maxDiscount" class="form-control" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                         placeholder="Max Amount" 
                         value="<%= typeof editCoupon !== 'undefined' && editCoupon ? editCoupon.maxDiscount || '' : '' %>" 
                         min="0" step="0.01">
                  <small style="font-size: 12px; color: #666;">For percentage type only</small>
                  <div class="form-error" id="maxDiscount-error"></div>
                </div>
              </div>

              <!-- Row 4: Start Date, End Date -->
              <div class="form-row" style="display: flex; flex-wrap: wrap; margin-left: -10px; margin-right: -10px;">
                <div class="form-group col-md-6" style="flex: 0 0 50%; max-width: 50%; padding-left: 10px; padding-right: 10px; margin-bottom: 1rem;">
                  <label for="startDate" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 14px;">Start Date</label>
                  <input type="datetime-local" id="startDate" name="startDate" class="form-control" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                         value="<%= typeof editCoupon !== 'undefined' && editCoupon && editCoupon.startDate ? new Date(editCoupon.startDate).toISOString().slice(0, 16) : '' %>">
                  <div class="form-error" id="startDate-error"></div>
                </div>
                <div class="form-group col-md-6" style="flex: 0 0 50%; max-width: 50%; padding-left: 10px; padding-right: 10px; margin-bottom: 1rem;">
                  <label for="endDate" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 14px;">End Date</label>
                  <input type="datetime-local" id="endDate" name="endDate" class="form-control" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                         value="<%= typeof editCoupon !== 'undefined' && editCoupon && editCoupon.endDate ? new Date(editCoupon.endDate).toISOString().slice(0, 16) : '' %>">
                  <div class="form-error" id="endDate-error"></div>
                </div>
              </div>
            </form>
          </div>
          
          <!-- Action Buttons Outside Form -->
          <div style="margin-top: 20px; text-align: left;">
            <button type="button" class="btn btn-secondary" onclick="resetForm()" style="padding: 10px 20px; margin-right: 10px; border: none; background: #6c757d; color: white; border-radius: 4px; cursor: pointer; font-size: 14px;">Reset</button>
            <button type="submit" form="couponForm" class="btn btn-primary" id="submitBtn" style="padding: 10px 20px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer; font-size: 14px;">
              <% if (typeof editCoupon !== 'undefined' && editCoupon) { %>
                Update Coupon
              <% } else { %>
                Save Coupon
              <% } %>
            </button>
          </div>
        <% } else { %>
          <!-- No Permission Message -->
          <div class="alert alert-warning" style="padding: 15px; margin: 20px 0; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; color: #856404;">
            <h4>‚ö†Ô∏è Access Denied</h4>
            <p>You don't have permission to create or edit coupons. Please contact your administrator for access.</p>
          </div>
        <% } %>
        </div>

        <!-- Coupon List Table -->
        <h2 class="page-title mt-6">
          List Coupons 
          <span class="badge badge-info ml-2" id="couponCount"><%= coupons ? coupons.length : 0 %></span>
        </h2>
        
        <!-- Search and Filter -->
        <div class="mb-3">
          <div class="row">
            <div class="col-md-4">
              <input type="text" class="form-control" placeholder="Search coupons..." id="searchCoupons" onkeyup="searchTable()">
            </div>
            <div class="col-md-3">
              <select class="form-control" id="filterStatus" onchange="filterByStatus()">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
            <div class="col-md-3">
              <select class="form-control" id="filterType" onchange="filterByType()">
                <option value="">All Types</option>
                <option value="flat">Flat</option>
                <option value="percentage">Percentage</option>
              </select>
            </div>
            <div class="col-md-2">
              <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
            </div>
          </div>
        </div>
        
        <div class="table-wrap" style="width: 100%; overflow-x: auto;">
          <table class="orders-table" id="couponsTable" style="width: 100%; min-width: 1200px;">
            <thead>
              <tr>
                <th onclick="sortTable(0)">ID <i class="sort-icon">‚Üï</i></th>
                <th onclick="sortTable(1)">Title <i class="sort-icon">‚Üï</i></th>
                <th onclick="sortTable(2)">Code <i class="sort-icon">‚Üï</i></th>
                <th>Image</th>
                <th onclick="sortTable(4)">Type <i class="sort-icon">‚Üï</i></th>
                <th onclick="sortTable(5)">Discount <i class="sort-icon">‚Üï</i></th>
                <th onclick="sortTable(6)">Min Purchase <i class="sort-icon">‚Üï</i></th>
                <th onclick="sortTable(7)">Max Discount <i class="sort-icon">‚Üï</i></th>
                <th>First Order</th>
                <th onclick="sortTable(9)">Start Date <i class="sort-icon">‚Üï</i></th>
                <th onclick="sortTable(10)">End Date <i class="sort-icon">‚Üï</i></th>
                <th onclick="sortTable(11)">Status <i class="sort-icon">‚Üï</i></th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <% if (coupons && coupons.length > 0) { %>
                <% coupons.forEach(c => { %>
                  <tr>
                    <td><span class="coupon-id"><%= c._id.toString().substring(c._id.toString().length - 6) %></span></td>
                    <td><strong><%= c.title %></strong></td>
                    <td><code><%= c.code %></code></td>
                    <td>
                      <% if (c.img) { %>
                        <img src="<%= c.img %>" alt="<%= c.title %>" width="60" class="img-thumbnail cursor-pointer" 
                             onclick="showImageModal('<%= c.img %>', '<%= c.title %>')">
                      <% } else { %>
                        <span class="text-muted">No Image</span>
                      <% } %>
                    </td>
                    <td>
                      <span class="badge badge-<%= c.discountType === 'percentage' ? 'warning' : 'info' %>">
                        <%= c.discountType ? c.discountType.toUpperCase() : 'N/A' %>
                      </span>
                    </td>
                    <td>
                      <strong>
                        <% if (c.discountType === 'percentage') { %>
                          <%= c.discount || 0 %>%
                        <% } else { %>
                          ‚Çπ<%= c.discount || 0 %>
                        <% } %>
                      </strong>
                    </td>
                    <td><%= c.minPurchase ? '‚Çπ' + c.minPurchase : '-' %></td>
                    <td><%= c.maxDiscount ? '‚Çπ' + c.maxDiscount : '-' %></td>
                    <td>
                      <span class="badge <%= c.firstOrderOnly ? 'badge-success' : 'badge-secondary' %>">
                        <%= c.firstOrderOnly ? 'Yes' : 'No' %>
                      </span>
                    </td>
                    <td>
                      <%= c.startDate ? new Date(c.startDate).toLocaleDateString() : '-' %>
                    </td>
                    <td>
                      <% 
                        const now = new Date();
                        const endDate = c.endDate ? new Date(c.endDate) : null;
                        const isExpired = endDate && endDate < now;
                      %>
                      <span class="<%= isExpired ? 'text-danger' : '' %>">
                        <%= endDate ? endDate.toLocaleDateString() : '-' %>
                        <% if (isExpired) { %><br><small>(Expired)</small><% } %>
                      </span>
                    </td>
                    <td>
                      <span class="badge <%= c.status === 'Active' ? 'badge-success' : 'badge-danger' %>">
                        <%= c.status || 'Inactive' %>
                      </span>
                    </td>
                    <td>
                      <div class="action-buttons" style="display: flex; gap: 5px; justify-content: center;">
                        <button class="btn-mini btn-edit" onclick="editCoupon('<%= c._id %>')" title="Edit">
                          ‚úèÔ∏è
                        </button>
                        <button class="btn-mini btn-toggle" onclick="toggleStatus('<%= c._id %>', '<%= c.status %>')" title="<%= c.status === 'Active' ? 'Deactivate' : 'Activate' %>">
                          <%= c.status === 'Active' ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è' %>
                        </button>
                        <button class="btn-mini btn-delete" onclick="deleteCoupon('<%= c._id %>', '<%= c.title %>')" title="Delete">
                          üóëÔ∏è
                        </button>
                      </div>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr id="noCouponsRow">
                  <td colspan="13" style="text-align:center;">
                    <div class="empty-state">
                      <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
                      <h5>No coupons available</h5>
                      <p>Create your first coupon to get started!</p>
                    </div>
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
        </div> <!-- End main-content -->
      </div> <!-- End content -->

      <!-- Image Modal -->
      <div id="imageModal" class="modal" style="display: none;">
        <div class="modal-content">
          <span class="close" onclick="closeImageModal()">&times;</span>
          <img id="modalImage" src="" alt="" style="width: 100%; max-width: 500px;">
          <p id="modalImageTitle"></p>
        </div>
      </div>

      <script>
        // Initialize form on page load
        document.addEventListener('DOMContentLoaded', function() {
          toggleMaxDiscount();
          validateDates();
          
          // Auto-uppercase coupon code
          document.getElementById('code').addEventListener('input', function() {
            this.value = this.value.toUpperCase();
          });
        });

        // Generate random coupon code
        function generateCode() {
          const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
          let result = '';
          for (let i = 0; i < 8; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
          }
          document.getElementById('code').value = result;
        }

        // Toggle max discount field based on discount type
        function toggleMaxDiscount() {
          const discountType = document.getElementById('discountType').value;
          const maxDiscountGroup = document.getElementById('maxDiscountGroup');
          const discountSymbol = document.getElementById('discount-symbol');
          
          if (discountType === 'percentage') {
            maxDiscountGroup.style.display = 'block';
            discountSymbol.textContent = '%';
            document.getElementById('discount').max = '100';
          } else {
            maxDiscountGroup.style.display = 'none';
            discountSymbol.textContent = '‚Çπ';
            document.getElementById('discount').removeAttribute('max');
          }
        }

        // Validate date inputs
        function validateDates() {
          const startDate = document.getElementById('startDate');
          const endDate = document.getElementById('endDate');
          
          startDate.addEventListener('change', function() {
            if (endDate.value && new Date(this.value) > new Date(endDate.value)) {
              alert('Start date cannot be after end date');
              this.value = '';
            }
          });
          
          endDate.addEventListener('change', function() {
            if (startDate.value && new Date(this.value) < new Date(startDate.value)) {
              alert('End date cannot be before start date');
              this.value = '';
            }
          });
        }

        // Reset form
        function resetForm() {
          if (confirm('Are you sure you want to reset the form?')) {
            document.getElementById('couponForm').reset();
            clearErrors();
            toggleMaxDiscount();
          }
        }

        // Clear form errors
        function clearErrors() {
          const errorElements = document.querySelectorAll('.form-error');
          errorElements.forEach(el => el.textContent = '');
        }

        // Form validation
        document.getElementById('couponForm').addEventListener('submit', function(e) {
          clearErrors();
          let isValid = true;
          
          // Validate required fields
          const requiredFields = ['title', 'code', 'discountType', 'discount'];
          requiredFields.forEach(field => {
            const element = document.getElementById(field);
            if (!element.value.trim()) {
              document.getElementById(field + '-error').textContent = 'This field is required';
              isValid = false;
            }
          });
          
          // Validate discount value
          const discountType = document.getElementById('discountType').value;
          const discountValue = parseFloat(document.getElementById('discount').value);
          
          if (discountType === 'percentage' && discountValue > 100) {
            document.getElementById('discount-error').textContent = 'Percentage cannot be more than 100%';
            isValid = false;
          }
          
          if (discountValue <= 0) {
            document.getElementById('discount-error').textContent = 'Discount value must be greater than 0';
            isValid = false;
          }
          
          // Validate min purchase vs max discount
          const minPurchase = parseFloat(document.getElementById('minPurchase').value) || 0;
          const maxDiscount = parseFloat(document.getElementById('maxDiscount').value) || 0;
          
          if (maxDiscount > 0 && minPurchase > 0 && maxDiscount >= minPurchase) {
            document.getElementById('maxDiscount-error').textContent = 'Max discount should be less than minimum purchase';
            isValid = false;
          }
          
          if (!isValid) {
            e.preventDefault();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        });

        // Search functionality
        function searchTable() {
          const input = document.getElementById('searchCoupons');
          const filter = input.value.toLowerCase();
          const table = document.getElementById('couponsTable');
          const rows = table.getElementsByTagName('tr');
          
          for (let i = 1; i < rows.length; i++) {
            const cells = rows[i].getElementsByTagName('td');
            let found = false;
            
            for (let j = 0; j < cells.length - 1; j++) {
              if (cells[j].textContent.toLowerCase().indexOf(filter) > -1) {
                found = true;
                break;
              }
            }
            
            rows[i].style.display = found ? '' : 'none';
          }
          updateVisibleCount();
        }

        // Filter by status
        function filterByStatus() {
          const filter = document.getElementById('filterStatus').value.toLowerCase();
          filterTable(11, filter); // Status column index
        }

        // Filter by type
        function filterByType() {
          const filter = document.getElementById('filterType').value.toLowerCase();
          filterTable(4, filter); // Type column index
        }

        // Generic filter function
        function filterTable(columnIndex, filter) {
          const table = document.getElementById('couponsTable');
          const rows = table.getElementsByTagName('tr');
          
          for (let i = 1; i < rows.length; i++) {
            const cell = rows[i].getElementsByTagName('td')[columnIndex];
            if (cell) {
              const cellText = cell.textContent.toLowerCase();
              rows[i].style.display = !filter || cellText.includes(filter) ? '' : 'none';
            }
          }
          updateVisibleCount();
        }

        // Clear all filters
        function clearFilters() {
          document.getElementById('searchCoupons').value = '';
          document.getElementById('filterStatus').value = '';
          document.getElementById('filterType').value = '';
          
          const table = document.getElementById('couponsTable');
          const rows = table.getElementsByTagName('tr');
          
          for (let i = 1; i < rows.length; i++) {
            rows[i].style.display = '';
          }
          updateVisibleCount();
        }

        // Update visible count
        function updateVisibleCount() {
          const table = document.getElementById('couponsTable');
          const rows = table.getElementsByTagName('tr');
          let visibleCount = 0;
          
          for (let i = 1; i < rows.length; i++) {
            if (rows[i].style.display !== 'none' && !rows[i].id.includes('noCouponsRow')) {
              visibleCount++;
            }
          }
          
          document.getElementById('couponCount').textContent = visibleCount;
        }

        // Sort table
        let sortDirection = {};
        function sortTable(columnIndex) {
          const table = document.getElementById('couponsTable');
          const tbody = table.querySelector('tbody');
          const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => !row.id.includes('noCouponsRow'));
          
          const direction = sortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';
          sortDirection[columnIndex] = direction;
          
          rows.sort((a, b) => {
            const aValue = a.cells[columnIndex].textContent.trim();
            const bValue = b.cells[columnIndex].textContent.trim();
            
            const aNum = parseFloat(aValue.replace(/[^\d.-]/g, ''));
            const bNum = parseFloat(bValue.replace(/[^\d.-]/g, ''));
            
            let comparison;
            if (!isNaN(aNum) && !isNaN(bNum)) {
              comparison = aNum - bNum;
            } else {
              comparison = aValue.localeCompare(bValue);
            }
            
            return direction === 'asc' ? comparison : -comparison;
          });
          
          rows.forEach(row => tbody.appendChild(row));
        }

        // Edit coupon
        function editCoupon(id) {
          window.location.href = `/coupon-create?edit=${id}`;
        }

        // Toggle coupon status
        async function toggleStatus(id, currentStatus) {
          const newStatus = currentStatus === 'Active' ? 'Inactive' : 'Active';
          
          if (confirm(`Change coupon status to ${newStatus}?`)) {
            try {
              const response = await fetch(`/api/coupons/${id}/status`, {
                method: 'PATCH',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: newStatus })
              });
              
              if (response.ok) {
                location.reload();
              } else {
                alert('Failed to update status');
              }
            } catch (error) {
              alert('Error updating status');
            }
          }
        }

        // Delete coupon
        async function deleteCoupon(id, title) {
          if (confirm(`Are you sure you want to delete "${title}"? This action cannot be undone.`)) {
            try {
              const response = await fetch(`/api/coupons/${id}`, {
                method: 'DELETE'
              });
              
              if (response.ok) {
                location.reload();
              } else {
                alert('Failed to delete coupon');
              }
            } catch (error) {
              alert('Error deleting coupon');
            }
          }
        }

        // Image modal functions
        function showImageModal(src, title) {
          document.getElementById('modalImage').src = src;
          document.getElementById('modalImageTitle').textContent = title;
          document.getElementById('imageModal').style.display = 'block';
        }

        function closeImageModal() {
          document.getElementById('imageModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
          const modal = document.getElementById('imageModal');
          if (event.target == modal) {
            modal.style.display = 'none';
          }
        }
      </script>

      <style>
        .required {
          color: #e74c3c;
        }
        
        .form-error {
          color: #e74c3c;
          font-size: 0.875rem;
          margin-top: 0.25rem;
        }
        
        .current-image {
          padding: 0.5rem;
          border: 1px solid #dee2e6;
          border-radius: 0.25rem;
          background-color: #f8f9fa;
        }
        
        .coupon-id {
          font-family: monospace;
          background-color: #f8f9fa;
          padding: 0.2rem 0.4rem;
          border-radius: 0.25rem;
        }
        
        .action-buttons {
          white-space: nowrap;
        }
        
        .action-buttons .btn-small {
          margin: 0 0.1rem;
          padding: 0.25rem 0.5rem;
          font-size: 0.75rem;
        }
        
        .empty-state {
          padding: 2rem;
          text-align: center;
          color: #6c757d;
        }
        
        .sort-icon {
          font-size: 0.8rem;
          margin-left: 0.25rem;
          opacity: 0.5;
        }
        
        .cursor-pointer {
          cursor: pointer;
        }
        
        .modal {
          position: fixed;
          z-index: 9999;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.9);
        }
        
        .modal-content {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          text-align: center;
        }
        
        .close {
          color: white;
          float: right;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
          position: absolute;
          top: 10px;
          right: 25px;
        }
        
        .alert {
          padding: 0.75rem 1.25rem;
          margin-bottom: 1rem;
          border: 1px solid transparent;
          border-radius: 0.25rem;
        }
        
        .alert-success {
          color: #155724;
          background-color: #d4edda;
          border-color: #c3e6cb;
        }
        
        .alert-danger {
          color: #721c24;
          background-color: #f8d7da;
          border-color: #f5c6cb;
        }
        
        .alert-dismissible .close {
          position: relative;
          top: -0.75rem;
          right: -1.25rem;
          padding: 0.75rem 1.25rem;
          color: inherit;
          background: none;
          border: none;
          font-size: 1.5rem;
          line-height: 1;
          cursor: pointer;
        }
      </style>

      <script src="/js/dashboard.js" defer></script>
      <%- include('partials/footer') %>