<%- include('partials/head') %>
<%- include('partials/sidebar') %>
<%- include('partials/topbar') %>

<div class="content">
  <h1 class="page-title">List Coupons</h1>

  <div class="table-wrap">
    <table class="orders-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Title</th>
          <th>Code</th>
          <th>Image</th>
          <th>Discount Type</th>
          <th>Discount</th>
          <th>Min Purchase</th>
          <th>Max Discount</th>
          <th>First Order Only</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Status</th>
          <% if (userRole === 'superadmin' || hasFullAccess || (userPermissions && userPermissions.coupons && (userPermissions.coupons.edit || userPermissions.coupons.delete))) { %>
          <th>Action</th>
          <% } %>
        </tr>
      </thead>
      <tbody>
        <% if (coupons && coupons.length > 0) { %>
          <% coupons.forEach(c => { %>
            <tr>
              <td><%= c._id %></td>
              <td><%= c.title %></td>
              <td><%= c.code %></td>
              <td>
                <% if (c.img) { %>
                  <img src="<%= c.img %>" alt="<%= c.title %>" width="60" />
                <% } else { %>
                  No Image
                <% } %>
              </td>
              <td><%= c.discountType || "-" %></td>
              <td><%= c.discount || 0 %></td>
              <td><%= c.minPurchase || "-" %></td>
              <td><%= c.maxDiscount || "-" %></td>
              <td><%= c.firstOrderOnly ? "Yes" : "No" %></td>
              <td><%= c.startDate ? new Date(c.startDate).toLocaleDateString() : "-" %></td>
              <td><%= c.endDate ? new Date(c.endDate).toLocaleDateString() : "-" %></td>
              <td>
                <span class="badge <%= (c.status || 'Inactive').toLowerCase() %>">
                  <%= c.status %>
                </span>
              </td>
              <% if (userRole === 'superadmin' || hasFullAccess || (userPermissions && userPermissions.coupons && (userPermissions.coupons.edit || userPermissions.coupons.delete))) { %>
              <td>
                <% if (userRole === 'superadmin' || hasFullAccess || (userPermissions && userPermissions.coupons && userPermissions.coupons.edit)) { %>
                <a href="/coupons/edit/<%= c._id %>" class="btn-small">Edit</a>
                <% } %>
                <% if (userRole === 'superadmin' || hasFullAccess || (userPermissions && userPermissions.coupons && userPermissions.coupons.delete)) { %>
                <form action="/coupons/delete/<%= c._id %>" method="POST" style="display:inline;">
                  <button type="submit" class="btn-small danger">Delete</button>
                </form>
                <% } %>
              </td>
              <% } %>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="12" class="text-center">
              No coupons found.
            </td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<script src="/js/dashboard.js" defer></script>
<%- include('partials/footer') %>